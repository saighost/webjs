#!/usr/bin/env node

//CLI

var web = require('../');
var program = require('commander');
var mkdirp = require('mkdirp');
var fs = require('fs');
var asynclist = require('asynclist');
program
    .version(web.version)
    .option('-c, --cookie', 'Add cookie support')
    .option('-s, --session', 'Add session support')
    .option('-b, --body', 'Add body parser support')
    .option('--mustache', 'Add mustache template engine supportt (defaults to jade)')
    .option('--ejs', 'Add ejs template engine supportt (defaults to jade)')
    .option('--dev', 'Set the development mode (defaults to production)')
    .parse(process.argv);

program.template = 'jade';
if (program.mustache) program.template = 'mustache';
if (program.ejs) program.template = 'ejs';
program.mode = 'pro';
if (program.dev) program.mode = 'dev';
var path = program.args.shift() || '.';

var index_html = [
    '<!DOCTYPE html>',
    '<html>',
    '   <head>',
    '       <title>webjs Quick Start</title>',
    '       <link rel=\'stylesheet\' href=\'/css/style.css\' />',
    '   </head>',
    '   <body>',
    '       <header>',
    '           <h1>Thanks for using webjs</h1>',
    '       </header>',
    '       <section>',
    '           <article>',
    '               <p>Let\'s get start with webjs.</p>  <a href="/hello" target="_top">Example</a>',
    '           </article>',
    '       </section>',
    '   </body>',
    '</html>'
].join('\r\n');
var css = [
    'body {',
    '   padding: 50px;',
    '   font: 14px "Lucida Grande", Helvetica, Arial, sans-serif;',
    '}',
    'a {',
    '   color: #00B7FF;',
    '}'
].join('\r\n');
var index = [
    'module.exports = function () {',
    '    var web = require(\'webjs\');',
    '',
    '    web.run()',
    '        .config({',
    '            \'view engine\': \'' + program.template + '\',',
    '            \'views\': __dirname + \'/../views\',',
    '            \'mode\': \'' + program.mode  + '\'',
    '        })',
    '        .use(web.static(__dirname + \'/../public\'))',
    (program.cookie ? '        .use(web.cookieParser())' : ''),
    (program.session ? '        .use(web.session())' : ''),
    (program.body ? '        .use(web.bodyParser())' : ''),
    '        .extend(__dirname + \'/router\');',
    '}'
].join('\r\n');
var router = [
    'module.exports = function (web) {',
    '   web.get({',
    '       \'/hello\': function (req, res) {',
    (program.session ? '           if (isNaN(req.session.times))\r\n               req.session.times = 0\r\n           else\r\n               req.session.times++;' : ''),
    '           res.render(\'hello\', {',
    (program.session ? '               times: req.session.times,' : ''),
    '               title: \'webjs\'',
    '           });',
    '       }',
    '   });',   
    '};'
].join('\r\n');
var server = [
    'require(__dirname + \'/controllers/\')()'
].join('\r\n');
var hello = [
    'html',
    '    head',
    '        title Hello World!',
    '        link(type=\'text/css\', rel=\'stylesheet\', href=\'/css/style.css\')',
    '    h1 Hello World!',
    '    p Welcome to #{title}',
    (program.session ? '    p You had refreshed #{times} times' : '')
].join('\r\n');

function emptyDirectory(path, fn) {
  fs.readdir(path, function(err, files){
    if (err && 'ENOENT' != err.code) throw err;
    fn(!files || !files.length);
  });
}
function write(path, str, fn) {
  fs.writeFile(path, str, function () {
    console.log('   \x1b[36mcreate\x1b[0m : ' + path);
    fn();
  });
}
function mkdir(path, fn) {
  mkdirp(path, 0755, function(err){
    if (err) throw err;
    console.log('   \033[36mcreate\033[0m : ' + path);
    fn && fn();
  });
}
mkdir(path, function(){
    //Public
    var paths = [
        path + '/public',
        path + '/controllers',
        path + '/modules',
        path + '/views',
        path + '/public/js',
        path + '/public/css'
    ];
    var list = paths.map(function (_path) {
        return function () {
            mkdir(_path, function () {
                tasks.trigger(_path);
            });
        };
    });
    var tasks = new asynclist(list);
    tasks.assign(function () {
        var files = [
            [path + '/public/css/style.css', css],
            [path + '/public/index.html', index_html],
            [path + '/controllers/index.js', index],
            [path + '/controllers/router.js', router],
            [path + '/views/hello.jade', hello],
            [path + '/server.js', server]
        ];
        var _list = files.map(function (file) {
            return function () {
                write(file[0], file[1], function () {
                    filesTasks.trigger(file);
                });
            };
        });
        var filesTasks = new asynclist(_list);
        filesTasks.assign(function () {
            console.log('Enjoy!');
            process.exit(1);
        });
        filesTasks.run();
    });
    tasks.run();
});